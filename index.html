<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMRJ Super Admin System</title>
    <style>
        /* =========================================
           CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Super Admin Theme (Dark Navy & Gold/Purple Accent) */
            --color-primary: #1e293b;       /* Slate 800 */
            --color-primary-light: #334155; /* Slate 700 */
            --color-accent: #6366f1;       /* Indigo 500 */
            --color-accent-hover: #4f46e5; /* Indigo 600 */
            --color-bg: #f8fafc;           /* Slate 50 */
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --color-text-light: #64748b;
            --color-border: #e2e8f0;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            
            --spacing-4: 4px;
            --spacing-8: 8px;
            --spacing-16: 16px;
            --spacing-24: 24px;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* =========================================
           LOGIN SCREEN
           ========================================= */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .login-box h2 { color: #1e293b; margin-bottom: 24px; font-size: 24px; font-weight: 800; }
        .input-group { margin-bottom: 16px; text-align: left; }
        .input-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b; }
        .input-group input {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1;
            border-radius: 6px; font-size: 14px; transition: border 0.2s;
        }
        .input-group input:focus { outline: none; border-color: var(--color-accent); }
        .btn-login {
            width: 100%; padding: 12px; background: var(--color-accent); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;
            transition: background 0.2s;
        }
        .btn-login:hover { background: var(--color-accent-hover); }

        /* =========================================
           LAYOUT (SIDEBAR & MAIN)
           ========================================= */
        .sidebar {
            width: 280px; background: var(--color-primary); color: white;
            display: flex; flex-direction: column; border-right: 1px solid #334155;
        }
        .sidebar-header {
            padding: 24px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; gap: 12px;
        }
        .logo-circle {
            width: 40px; height: 40px; background: var(--color-accent);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 18px;
        }
        .sidebar-title { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
        
        .nav-menu { list-style: none; padding: 20px 16px; flex: 1; overflow-y: auto; }
        .nav-item { margin-bottom: 4px; }
        .nav-btn {
            width: 100%; text-align: left; padding: 12px 16px;
            background: transparent; border: none; color: #94a3b8;
            cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 10px; transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: var(--color-accent); color: white; font-weight: 600; }
        
        .sidebar-footer {
            padding: 16px; border-top: 1px solid #334155; font-size: 12px; color: #64748b;
            text-align: center;
        }

        .main-content {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: var(--color-bg);
        }

        .top-bar {
            height: 64px; background: white; border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
        }
        .current-context {
            display: flex; align-items: center; gap: 12px;
            font-size: 14px; font-weight: 600; color: var(--color-text-light);
        }
        .context-badge {
            background: #eff6ff; color: #3b82f6; padding: 4px 12px;
            border-radius: 20px; border: 1px solid #bfdbfe; font-weight: 600;
        }

        .content-area {
            flex: 1; overflow-y: auto; padding: 24px;
        }

        /* =========================================
           COMPONENTS (CARDS, TABLES, FORMS)
           ========================================= */
        .grid-dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px; margin-bottom: 32px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 8px;
            border: 1px solid var(--color-border); box-shadow: var(--shadow);
        }
        .stat-label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--color-primary); margin-top: 8px; }

        .card {
            background: white; border-radius: 8px; border: 1px solid var(--color-border);
            box-shadow: var(--shadow); overflow: hidden; margin-bottom: 24px;
        }
        .card-header {
            padding: 16px 24px; border-bottom: 1px solid var(--color-border);
            background: #f8fafc; display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 16px; font-weight: 700; color: var(--color-primary); }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { 
            background: #f1f5f9; text-align: left; padding: 12px 16px; 
            font-weight: 600; color: #475569; border-bottom: 1px solid var(--color-border); white-space: nowrap;
        }
        td { padding: 12px 16px; border-bottom: 1px solid var(--color-border); color: #334155; }
        tr:hover { background: #f8fafc; }
        tr:last-child td { border-bottom: none; }

        .btn {
            padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px;
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-primary:hover { background: var(--color-accent-hover); }
        .btn-danger { background: #fee2e2; color: var(--color-error); }
        .btn-danger:hover { background: #fecaca; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }

        .context-selector { padding: 8px; border-radius: 6px; border: 1px solid var(--color-border); font-size: 14px; min-width: 200px; }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white; width: 90%; max-width: 500px; border-radius: 8px;
            padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--color-primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #475569; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        
        /* Empty State */
        .empty-state {
            text-align: center; padding: 48px; color: #94a3b8;
        }
        .empty-icon { font-size: 40px; margin-bottom: 16px; display: block; opacity: 0.5; }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">üõ°Ô∏è</div>
            <h2>Super Admin Login</h2>
            <form onsubmit="handleAdminLogin(event)">
                <div class="input-group">
                    <label>Super Username</label>
                    <input type="text" id="adminUser" placeholder="admin" required>
                </div>
                <div class="input-group">
                    <label>Super Password</label>
                    <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-login">Masuk Dashboard</button>
            </form>
            <p style="margin-top: 20px; font-size: 12px; color: #94a3b8;">
                Gunakan: <strong>admin</strong> / <strong>master</strong>
            </p>
        </div>
    </div>

    <!-- APP STRUCTURE -->
    <div class="sidebar hidden" id="mainSidebar">
        <div class="sidebar-header">
            <div class="logo-circle">SA</div>
            <div class="sidebar-title">GMRJ Admin</div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <button class="nav-btn active" onclick="switchTab('dashboard')">
                    üìä Dashboard Global
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-btn" onclick="switchTab('users')">
                    üë• Manajemen Stokis (User)
                </button>
            </li>
            <li style="margin: 16px 0 8px 16px; font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700;">
                Editor Data Stokis
            </li>
            <li class="nav-item">
                <button class="nav-btn" onclick="switchTab('profile')">üë§ Profil Stokis</button>
            </li>
            <li class="nav-item">
                <button class="nav-btn" onclick="switchTab('products')">üì¶ Produk</button>
            </li>
            <li class="nav-item">
                <button class="nav-btn" onclick="switchTab('members')">üë• Member Stokis</button>
            </li>
            <li class="nav-item">
                <button class="nav-btn" onclick="switchTab('transactions')">üí∞ Transaksi</button>
            </li>
        </ul>
        <div class="sidebar-footer">
            v1.1.0 Super Admin<br>Realtime Sync + Migration
        </div>
    </div>

    <div class="main-content hidden" id="mainContent">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="current-context">
                Target Stokis:
                <select id="stokisSelector" class="context-selector" onchange="loadSelectedStokis(this.value)">
                    <option value="">-- Pilih Stokis --</option>
                </select>
                <span id="stokisStatus" class="badge badge-green hidden">Live Connected</span>
            </div>
            <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>

        <!-- DYNAMIC CONTENT -->
        <div class="content-area" id="contentArea">
            <!-- Will be populated by JS -->
        </div>
    </div>

    <!-- GENERIC MODAL -->
    <div id="genericModal" class="modal">
        <div class="modal-box">
            <h3 class="modal-title" id="modalTitle">Judul Modal</h3>
            <div id="modalBody">
                <!-- Form content goes here -->
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn" style="background: #e2e8f0;" onclick="closeModal()">Batal</button>
                <button class="btn btn-primary" id="modalActionBtn">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MIGRASI DATA MODAL (BARU) -->
    <div id="migrateModal" class="modal">
        <div class="modal-box">
            <h3 class="modal-title">üìã Migrasi / Copy Data Stokis</h3>
            <div class="form-group">
                <label>Sumber Data (Dari)</label>
                <select id="migrateSource"></select>
            </div>
            <div class="form-group">
                <label>Tujuan Data (Ke)</label>
                <select id="migrateDest"></select>
            </div>
            <div class="form-group">
                <label>Opsi Penimpaan</label>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                    <input type="checkbox" id="migrateOverwrite" style="width: 20px; height: 20px;">
                    <span style="font-size: 14px; color: #64748b;">Timpa data lama di stokis Tujuan (Hilangkan data asli)</span>
                </div>
                <small style="color: #ef4444; display: block; margin-top: 5px;">
                    ‚ö†Ô∏è Jika dicentang, data produk/member/transaksi lama di Tujuan akan HILANG diganti data Sumber.
                </small>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn" style="background: #e2e8f0;" onclick="closeMigrateModal()">Batal</button>
                <button class="btn btn-primary" onclick="executeMigrate()">Mulai Migrasi</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
      import { 
        initializeApp 
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import { 
        getFirestore, 
        collection, 
        doc, 
        getDoc,
        getDocs,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        query,
        where
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

      // --- KONFIGURASI FIREBASE (SAMA DENGAN APLIKASI STOKIS) ---
      const firebaseConfig = {
        apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
        authDomain: "sistem-stokis-gmrj.firebaseapp.com",
        projectId: "sistem-stokis-gmrj",
        storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
        messagingSenderId: "288883517168",
        appId: "1:288883517168:web:d5cdd864aa944205df8435",
        measurementId: "G-12KELDXJ1J"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const COLLECTION_STOKIS = 'stokisDatas';
      const COLLECTION_USERS = 'stokis_users'; // Koleksi khusus untuk menyimpan user/pass

      // --- STATE MANAGEMENT ---
      let currentStokisId = null;
      let currentDataUnsubscribe = null;
      let stokisCache = {}; // Cache data agar UI cepat

      // --- AUTH ---
      window.handleAdminLogin = (e) => {
        e.preventDefault();
        const u = document.getElementById('adminUser').value.trim();
        const p = document.getElementById('adminPass').value.trim();

        // Simple Hardcoded Check for Super Admin
        if (u === 'admin' && p === 'master') {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            initDashboard();
        } else {
            alert('Akses Ditolak! Gunakan: admin / master');
        }
      };

      window.logout = () => {
        location.reload();
      };

      // --- CORE FUNCTIONS ---

      async function initDashboard() {
        await loadStokisList();
        renderDashboardGlobal();
      }

      // 1. Fetch semua list stokis dari collection 'stokisDatas'
      async function loadStokisList() {
        const selector = document.getElementById('stokisSelector');
        selector.innerHTML = '<option value="">-- Pilih Stokis untuk Edit --</option>';
        
        try {
            const querySnapshot = await getDocs(collection(db, COLLECTION_STOKIS));
            querySnapshot.forEach((doc) => {
                const username = doc.id; // Document ID adalah username
                const data = doc.data();
                const nama = data.profile?.namaStokis || username;
                
                const option = document.createElement('option');
                option.value = username;
                option.textContent = `${username} (${nama})`;
                selector.appendChild(option);
            });
        } catch (error) {
            console.error("Error fetching stokis list:", error);
            alert("Gagal memuat daftar Stokis. Cek koneksi Firestore.");
        }
      }

      // 2. Load data spesifik stokis (Realtime)
      window.loadSelectedStokis = (username) => {
        // Unsubscribe listener lama jika ada
        if (currentDataUnsubscribe) {
            currentDataUnsubscribe();
            currentDataUnsubscribe = null;
        }

        if (!username) {
            currentStokisId = null;
            document.getElementById('contentArea').innerHTML = `
                <div class="empty-state">
                    <span class="empty-icon">üëà</span>
                    <h3>Silakan Pilih Stokis</h3>
                    <p>Pilih nama Stokis di menu atas untuk mengelola data mereka.</p>
                </div>
            `;
            return;
        }

        currentStokisId = username;
        const docRef = doc(db, COLLECTION_STOKIS, username);

        // Realtime Listener
        currentDataUnsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                stokisCache[currentStokisId] = docSnap.data();
                document.getElementById('stokisStatus').classList.remove('hidden');
                document.getElementById('stokisStatus').className = 'badge badge-green';
                
                // Re-render tab yang sedang aktif
                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    if (tabName !== 'dashboard' && tabName !== 'users') {
                        renderTabContent(tabName);
                    }
                }
            } else {
                document.getElementById('stokisStatus').textContent = "Data Kosong";
                document.getElementById('stokisStatus').className = 'badge badge-red';
            }
        }, (error) => {
            console.error("Realtime error:", error);
            alert("Error realtime: " + error.message);
        });
      };

      // --- RENDER LOGIC ---

      window.switchTab = (tabName) => {
        // Update sidebar active state
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        const clickedBtn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.getAttribute('onclick').includes(tabName));
        if(clickedBtn) clickedBtn.classList.add('active');

        if (tabName === 'dashboard' || tabName === 'users') {
            // Global tabs don't need specific stokis selected
            renderDashboardGlobal();
          if(tabName === 'users') renderUsersManagement();
        } else {
          if (!currentStokisId) {
            document.getElementById('contentArea').innerHTML = `
              <div class="empty-state">
                <span class="empty-icon">‚ö†Ô∏è</span>
                <h3>Stokis Belum Dipilih</h3>
                <p>Silakan pilih Stokis di menu dropdown atas sebelum mengedit ${tabName}.</p>
              </div>
            `;
            return;
          }
          renderTabContent(tabName);
        }
      };

      function renderDashboardGlobal() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <h2 style="margin-bottom: 24px;">Dashboard Global</h2>
            <div class="grid-dashboard">
                <div class="stat-card">
                    <div class="stat-label">Total Stokis Terdaftar</div>
                    <div class="stat-value" id="global-count-stokis">...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Status Sistem</div>
                    <div class="stat-value" style="color: var(--color-success); font-size: 20px; margin-top: 12px;">üü¢ Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Database</div>
                    <div class="stat-value" style="font-size: 16px; margin-top: 14px;">Firestore (Realtime)</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Log Aktivitas Sistem</span>
                </div>
                <div style="padding: 24px;">
                    <p style="color: #64748b;">Selamat datang di Super Admin. Gunakan sidebar untuk navigasi.</p>
                    <ul style="margin-top: 16px; padding-left: 20px; color: #334155; line-height: 1.8;">
                        <li><strong>Manajemen Stokis:</strong> Untuk melihat dan mengedit Username/Password user stokis.</li>
                        <li><strong>Editor Data:</strong> Pilih stokis di pojok kanan atas, lalu edit Produk/Member mereka secara langsung.</li>
                        <li><strong>Migrasi:</strong> Gunakan tombol "Copy Data" di tabel user untuk memindahkan data akun lama ke akun baru.</li>
                    </ul>
                </div>
            </div>
        `;

        // Count stokis
        getDocs(collection(db, COLLECTION_STOKIS)).then(snap => {
            const counterElement = document.getElementById('global-count-stokis');
            if (counterElement) {
                counterElement.textContent = snap.size;
            }
        });
      }

      // --- USER MANAGEMENT (CREDENTIALS) + MIGRASI ---
      async function renderUsersManagement() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <h2 style="margin-bottom: 24px;">Manajemen Akun (Username & Password)</h2>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Daftar Pengguna Stokis</span>
                    <button class="btn btn-primary btn-sm" onclick="openAddUserModal()">+ Buat User Baru</button>
                </div>
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Password (Firestore)</th>
                                <th>Nama Stokis</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody><tr><td colspan="4" style="text-align:center;">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        `;

        // Kita gabungkan data dari 'stokisDatas' (profil) dan 'stokis_users' (auth)
        const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';

        if (stokisSnap.empty) {
            tbody.innerHTML = `<tr><td colspan="4" class="empty-state">Belum ada data stokis.</td></tr>`;
            return;
        }

        for (const doc of stokisSnap.docs) {
            const username = doc.id;
            const data = doc.data();
            const namaStokis = data.profile?.namaStokis || 'N/A';

            // Cek credentials di collection khusus users (jika ada), atau gunakan default
            let passDisplay = '<span style="color:#cbd5e1; font-style:italic;">Belum diset di Firestore</span>';
            
            try {
                const userDoc = await getDoc(doc(db, COLLECTION_USERS, username));
                if (userDoc.exists()) {
                    passDisplay = `<strong>${userDoc.data().password}</strong> <span style="font-size:10px; color:#64748b;">(Firestore)</span>`;
                }
            } catch(e) {}

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${username}</strong></td>
                <td>${passDisplay}</td>
                <td>${namaStokis}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEditUserModal('${username}')">Edit Password</button>
                    <button class="btn btn-sm btn-primary" style="background: var(--color-success);" onclick="openMigrateModal('${username}')">üìã Copy Data</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteStokisData('${username}')">Hapus Data</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
      }

      window.openEditUserModal = (username) => {
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const actionBtn = document.getElementById('modalActionBtn');

        modalTitle.textContent = `Edit Password: ${username}`;
        modalBody.innerHTML = `
            <div class="form-group">
                <label>Password Baru (Disimpan di Firestore)</label>
                <input type="text" id="newUserPass" placeholder="Masukkan password baru">
                <small style="color: #64748b;">Password ini akan digunakan jika aplikasi Stokis diupdate untuk mengecek Firestore.</small>
            </div>
        `;
        
        actionBtn.onclick = () => {
            const newPass = document.getElementById('newUserPass').value.trim();
            if (!newPass) return alert('Password tidak boleh kosong');
            
            // Save to 'stokis_users' collection
            setDoc(doc(db, COLLECTION_USERS, username), {
                username: username,
                password: newPass,
                updatedAt: new Date().toISOString()
            }).then(() => {
                alert('Password berhasil diperbarui di Firestore!');
                closeModal();
                renderUsersManagement();
            }).catch(e => alert('Error: ' + e.message));
        };
        
        document.getElementById('genericModal').classList.add('active');
      };

      window.deleteStokisData = async (username) => {
        if(!confirm(`Yakin hapus SEMUA data milik ${username}? Tidak bisa dikembalikan.`)) return;
        
        try {
            await deleteDoc(doc(db, COLLECTION_STOKIS, username));
            await deleteDoc(doc(db, COLLECTION_USERS, username));
            alert('Data dihapus.');
            renderUsersManagement();
            loadStokisList(); // refresh dropdown
        } catch(e) {
            alert('Gagal menghapus: ' + e.message);
        }
      };

      // --- FITUR MIGRASI DATA (BARU) ---
      window.openMigrateModal = (defaultSource) => {
        document.getElementById('migrateModal').classList.add('active');
        
        const sourceSel = document.getElementById('migrateSource');
        const destSel = document.getElementById('migrateDest');

        // Populate dropdowns with current stokis list
        sourceSel.innerHTML = '<option value="">-- Pilih Sumber --</option>';
        destSel.innerHTML = '<option value="">-- Pilih Tujuan --</option>';

        // Get list from DOM options (optimization) or re-fetch
        const options = document.querySelectorAll('#stokisSelector option');
        options.forEach(opt => {
            if (opt.value) {
                sourceSel.innerHTML += `<option value="${opt.value}" ${opt.value === defaultSource ? 'selected' : ''}>${opt.textContent}</option>`;
                destSel.innerHTML += `<option value="${opt.value}">${opt.textContent}</option>`;
            }
        });
      };

      window.closeMigrateModal = () => {
        document.getElementById('migrateModal').classList.remove('active');
      };

      window.executeMigrate = async () => {
        const sourceId = document.getElementById('migrateSource').value;
        const destId = document.getElementById('migrateDest').value;
        const overwrite = document.getElementById('migrateOverwrite').checked;

        if (!sourceId || !destId) return alert("Pilih Sumber dan Tujuan!");
        if (sourceId === destId) return alert("Sumber dan Tujuan tidak boleh sama!");

        try {
            // 1. Fetch Source Data
            const sourceSnap = await getDoc(doc(db, COLLECTION_STOKIS, sourceId));
            if (!sourceSnap.exists()) return alert("Data Sumber tidak ditemukan.");
            const sourceData = sourceSnap.data();

            // 2. Fetch Dest Data (to decide merge or overwrite)
            const destSnap = await getDoc(doc(db, COLLECTION_STOKIS, destId));
            
            let newData = {};

            if (overwrite || !destSnap.exists()) {
                // CASE OVERWRITE: Source replaces Dest completely
                console.log("Migrating: Overwrite mode");
                newData = sourceData;
            } else {
                // CASE MERGE: Source appended to Dest
                console.log("Migrating: Merge mode");
                const destData = destSnap.data();
                
                newData = {
                    profile: { ...destData.profile, ...sourceData.profile }, // Profil usually updated by source
                    products: [...(destData.products || []), ...(sourceData.products || [])],
                    members: [...(destData.members || []), ...(sourceData.members || [])],
                    transactions: [...(destData.transactions || []), ...(sourceData.transactions || [])]
                };
            }

            // 3. Write to Dest
            await setDoc(doc(db, COLLECTION_STOKIS, destId), newData, { merge: true });

            alert(`Berhasil migrasi data dari ${sourceId} ke ${destId}!`);
            closeMigrateModal();

            // Refresh UI if viewing the destination
            if (currentStokisId === destId) {
                // Realtime listener will catch it, but force reload just in case
                loadSelectedStokis(destId);
            }

        } catch (error) {
            console.error(error);
            alert("Gagal migrasi: " + error.message);
        }
      };

      // --- EDITOR TABS (Reuse Logic from Stokis App but adapted) ---

      function renderTabContent(tabName) {
        const data = stokisCache[currentStokisId];
        if (!data) return;

        const content = document.getElementById('contentArea');
        let html = '';

        if (tabName === 'profile') {
            const p = data.profile || {};
            html = `
                <h2>Profil Stokis: ${currentStokisId}</h2>
                <div class="card" style="margin-top:16px;">
                    <div class="card-header"><span class="card-title">Edit Data Identitas</span></div>
                    <div style="padding:24px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nama Koordinat</label>
                                <input type="text" id="p_koord" value="${p.namaKoordinat || ''}">
                            </div>
                            <div class="form-group">
                                <label>Kode Koordinat</label>
                                <input type="text" id="p_kode" value="${p.kodeKoordinat || ''}" style="text-transform:uppercase">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nama Stokis</label>
                            <input type="text" id="p_nama" value="${p.namaStokis || ''}">
                        </div>
                        <div class="form-group">
                            <label>Alamat</label>
                            <textarea id="p_alamat" rows="3">${p.alamatStokis || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>No WA Admin</label>
                            <input type="text" id="p_wa" value="${p.waNumber || ''}">
                        </div>
                        <button class="btn btn-primary" onclick="saveProfile()">Simpan Perubahan Profil</button>
                    </div>
                </div>
            `;
        } else if (tabName === 'products') {
            html = `<h2>Produk Milik: ${currentStokisId}</h2>
                    <button class="btn btn-primary" style="margin: 10px 0;" onclick="addProductModal()">+ Tambah Produk</button>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Nama Produk</th><th>Poin</th><th>Stok (Beli)</th><th>Aksi</th></tr></thead>
                                <tbody>
                                    ${(data.products || []).map((prod, idx) => `
                                        <tr>
                                            <td>${prod.name}</td>
                                            <td>${prod.point}</td>
                                            <td>${prod.pembelian}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" onclick="editProduct(${idx})">Edit</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteItem('products', ${idx})">Hapus</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
        } else if (tabName === 'members') {
            html = `<h2>Member Milik: ${currentStokisId}</h2>
                    <button class="btn btn-primary" style="margin: 10px 0;" onclick="addMemberModal()">+ Tambah Member</button>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>ID</th><th>Nama</th><th>Upline</th><th>Total Poin</th><th>Aksi</th></tr></thead>
                                <tbody>
                                    ${(data.members || []).map((m, idx) => `
                                        <tr>
                                            <td>${m.id}</td>
                                            <td>${m.name}</td>
                                            <td>${m.upline || '-'}</td>
                                            <td>${m.totalPoints ? m.totalPoints.toFixed(2) : 0}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" onclick="editMember(${idx})">Edit</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteItem('members', ${idx})">Hapus</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
        } else if (tabName === 'transactions') {
            html = `<h2>Riwayat Transaksi: ${currentStokisId}</h2>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Tgl</th><th>Kode</th><th>Member</th><th>Produk</th><th>Jml</th><th>Poin</th><th>Aksi</th></tr></thead>
                                <tbody>
                                    ${(data.transactions || []).map((t, idx) => `
                                        <tr>
                                            <td>${t.date}</td>
                                            <td>${t.code}</td>
                                            <td>${t.memberId}</td>
                                            <td>${t.productCode}</td>
                                            <td>${t.qty}</td>
                                            <td>${t.totalPoints}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" onclick="deleteItem('transactions', ${idx})">Batal</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
        }

        content.innerHTML = html;
      }

      // --- CRUD ACTIONS ---

      window.saveProfile = async () => {
          if(!confirm('Simpan profil stokis ini?')) return;
          const newData = {
              ...stokisCache[currentStokisId],
              profile: {
                  ...stokisCache[currentStokisId].profile,
                  namaKoordinat: document.getElementById('p_koord').value,
                  kodeKoordinat: document.getElementById('p_kode').value,
                  namaStokis: document.getElementById('p_nama').value,
                  alamatStokis: document.getElementById('p_alamat').value,
                  waNumber: document.getElementById('p_wa').value
              }
          };
          await saveData(newData);
      };

      window.deleteItem = async (collection, index) => {
          if(!confirm('Hapus item ini?')) return;
          const data = stokisCache[currentStokisId];
          data[collection].splice(index, 1);
          await saveData(data);
      };

      window.addProductModal = () => {
          showModalForm('Tambah Produk', `
              <input id="edit_name" placeholder="Nama Produk" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="edit_point" type="number" placeholder="Poin" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="edit_pembelian" type="number" placeholder="Stok Awal" class="form-control" style="width:100%; padding:8px;">
          `, async () => {
              const name = document.getElementById('edit_name').value;
              const point = parseFloat(document.getElementById('edit_point').value);
              const pembelian = parseInt(document.getElementById('edit_pembelian').value);
              if(!name || isNaN(point)) return alert('Data tidak lengkap');

              const data = stokisCache[currentStokisId];
              data.products.push({
                  code: 'PROD_'+Date.now(),
                  name, point, pembelian
              });
              await saveData(data);
          });
      };

      window.editProduct = (index) => {
          const prod = stokisCache[currentStokisId].products[index];
          showModalForm('Edit Produk', `
              <input id="edit_name" value="${prod.name}" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="edit_point" type="number" value="${prod.point}" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="edit_pembelian" type="number" value="${prod.pembelian}" class="form-control" style="width:100%; padding:8px;">
          `, async () => {
              prod.name = document.getElementById('edit_name').value;
              prod.point = parseFloat(document.getElementById('edit_point').value);
              prod.pembelian = parseInt(document.getElementById('edit_pembelian').value);
              await saveData(stokisCache[currentStokisId]);
          });
      };

      window.addMemberModal = () => {
           showModalForm('Tambah Member', `
              <input id="m_id" placeholder="ID Member" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="m_name" placeholder="Nama" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="m_upline" placeholder="Upline ID (Opsional)" class="form-control" style="width:100%; padding:8px;">
          `, async () => {
              const id = document.getElementById('m_id').value;
              const name = document.getElementById('m_name').value;
              const upline = document.getElementById('m_upline').value || null;
              if(!id || !name) return alert('Lengkapi data');

              const data = stokisCache[currentStokisId];
              data.members.push({ id, name, upline, status:'aktif', totalPoints:0, waNumber:'', koordinat:'' });
              await saveData(data);
          });
      };
      
      window.editMember = (index) => {
          const m = stokisCache[currentStokisId].members[index];
          showModalForm('Edit Member', `
              <input id="m_id" value="${m.id}" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="m_name" value="${m.name}" class="form-control" style="width:100%; margin-bottom:10px; padding:8px;">
              <input id="m_upline" value="${m.upline || ''}" class="form-control" style="width:100%; padding:8px;">
              <select id="m_status" class="form-control" style="width:100%; padding:8px;">
                  <option value="aktif" ${m.status==='aktif'?'selected':''}>Aktif</option>
                  <option value="tidak aktif" ${m.status==='tidak aktif'?'selected':''}>Tidak Aktif</option>
              </select>
          `, async () => {
              m.id = document.getElementById('m_id').value;
              m.name = document.getElementById('m_name').value;
              m.upline = document.getElementById('m_upline').value || null;
              m.status = document.getElementById('m_status').value;
              await saveData(stokisCache[currentStokisId]);
          });
      }

      // --- HELPER: SAVE DATA TO FIRESTORE ---
      async function saveData(newData) {
          try {
              await setDoc(doc(db, COLLECTION_STOKIS, currentStokisId), newData, { merge: true });
              // Cache will update via realtime listener
              alert('Data berhasil disimpan dan disinkronkan!');
              closeModal();
          } catch (e) {
              alert('Gagal menyimpan: ' + e.message);
          }
      }

      // --- MODAL HELPER ---
      function showModalForm(title, htmlContent, onSave) {
          document.getElementById('modalTitle').textContent = title;
          document.getElementById('modalBody').innerHTML = htmlContent;
          document.getElementById('modalActionBtn').onclick = onSave;
          document.getElementById('genericModal').classList.add('active');
      }

      window.closeModal = () => {
          document.getElementById('genericModal').classList.remove('active');
      }

      window.openAddUserModal = () => {
          const modalTitle = document.getElementById('modalTitle');
          const modalBody = document.getElementById('modalBody');
          const actionBtn = document.getElementById('modalActionBtn');

          modalTitle.textContent = "Buat User Stokis Baru";
          modalBody.innerHTML = `
              <div class="form-group">
                  <label>Username (ID Dokumen)</label>
                  <input type="text" id="newUserName" style="text-transform:lowercase">
              </div>
              <div class="form-group">
                  <label>Password</label>
                  <input type="text" id="newUserPass">
              </div>
              <div class="form-group">
                  <label>Nama Stokis</label>
                  <input type="text" id="newUserRealName">
              </div>
          `;
          
          actionBtn.onclick = async () => {
              const u = document.getElementById('newUserName').value.trim().toLowerCase();
              const p = document.getElementById('newUserPass').value.trim();
              const n = document.getElementById('newUserRealName').value.trim();
              
              if(!u || !p) return alert('Lengkapi semua field');
              
              // 1. Save Credentials
              await setDoc(doc(db, COLLECTION_USERS, u), { username: u, password: p, createdAt: new Date() });
              
              // 2. Initialize Empty Data
              await setDoc(doc(db, COLLECTION_STOKIS, u), {
                  profile: { namaStokis: n, kodeKoordinat: 'NEW' },
                  products: [], members: [], transactions: []
              });

              alert('User baru dibuat!');
              closeModal();
              renderUsersManagement();
              loadStokisList(); // Update dropdown
          };

          document.getElementById('genericModal').classList.add('active');
      }

    </script>
</body>
</html>